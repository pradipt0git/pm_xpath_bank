<!DOCTYPE html>
<html>
<head>
    <title>XPath Repository</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 1.1em;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-start:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: none;
        }
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }
        .btn-stop.show {
            display: block;
        }
        .btn-refresh {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-refresh:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(56, 239, 125, 0.4);
        }
        .btn-refresh:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .message {
            margin-top: 20px;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.show {
            display: block;
        }
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .viewer-section {
            margin-top: 40px;
            border-top: 2px solid #e0e0e0;
            padding-top: 30px;
        }
        .viewer-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        .file-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-selector select {
            flex: 1;
            margin-bottom: 0;
        }
        .btn-download {
            background: transparent;
            color: #667eea;
            padding: 0;
            border: none;
            cursor: pointer;
            font-size: 1.8em;
            transition: all 0.2s;
            line-height: 1;
        }
        .btn-download:hover:not(:disabled) {
            color: #5568d3;
            transform: scale(1.2);
        }
        .btn-download:disabled {
            color: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-recheck {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        .btn-recheck:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .btn-recheck:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .json-content {
            max-height: 500px;
            overflow-y: auto;
        }
        .page-section {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .page-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            overflow-x: auto;
            white-space: nowrap;
        }
        .page-header:hover {
            background: #5568d3;
        }
        .page-header::-webkit-scrollbar {
            height: 6px;
        }
        .page-header::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
        }
        .toggle-icon {
            transition: transform 0.3s;
        }
        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        .page-body {
            padding: 15px;
        }
        .page-body.collapsed {
            display: none;
        }
        .xpath-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .xpath-item label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .xpath-item input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.95em;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .xpath-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        .xpath-item input::-webkit-scrollbar {
            height: 6px;
        }
        .xpath-item input::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        .btn-save {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            width: auto;
        }
        .btn-save:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .btn-delete {
            background: transparent;
            color: #dc3545;
            padding: 2px;
            border: none;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.2s;
        }
        .btn-delete:hover {
            color: #a71d2a;
            transform: scale(1.15);
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .xpath-readonly {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-bottom: 8px;
            color: #666;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            white-space: nowrap;
        }
        .xpath-readonly::-webkit-scrollbar {
            height: 6px;
        }
        .xpath-readonly::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        .xpath-details {
            border-top: 1px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 10px;
        }
        .toggle-details {
            background: #6c757d;
            color: white;
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .toggle-details:hover {
            background: #5a6268;
        }
        .details-content {
            display: none;
            margin-top: 10px;
        }
        .details-content.show {
            display: block;
        }
        .no-data {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }
        .xpath-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
        }
        .xpath-count.unique {
            background: #28a745;
        }
        .xpath-count.multiple {
            background: #ffc107;
            color: #333;
        }
        .xpath-count.invalid {
            background: #dc3545;
        }
        .xpath-with-count {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .xpath-value {
            flex: 1;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>XPath Repository</h1>
            <div class="form-group">
                <label for="url">Enter URL:</label>
                <input type="text" id="url" value="{{ default_url }}" placeholder="https://example.com">
            </div>
            <div class="button-group">
                <button id="startBtn" class="btn-start" onclick="startCapture()">Start Capture</button>
                <button id="refreshBtn" class="btn-refresh" onclick="refreshJsonFile()" disabled>Refresh</button>
                <button id="stopBtn" class="btn-stop" onclick="stopCapture()">Stop Capture</button>
            </div>
            <div id="message" class="message"></div>

            <div class="viewer-section">
            <h2>Captured XPaths</h2>
            <div class="form-group">
                <label for="jsonFiles">Select JSON File:</label>
                <div class="file-selector">
                    <select id="jsonFiles" onchange="loadJsonFile()">
                        <option value="">-- Select a file --</option>
                    </select>
                    <button id="downloadBtn" class="btn-download" onclick="downloadCSV()" disabled title="Download as CSV">üì•</button>
                    <button id="recheckBtn" class="btn-recheck" onclick="openRecheckPage()" disabled>Recheck</button>
                </div>
            </div>
            <div id="jsonContent" class="json-content">
                <div class="no-data">Select a JSON file to view captured xpaths</div>
            </div>
        </div>
    </div>

    <script>
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message show ' + type;
            setTimeout(() => {
                messageDiv.className = 'message';
            }, 5000);
        }

        function startCapture() {
            const url = document.getElementById('url').value.trim();
            if (!url) {
                showMessage('Please enter a URL', 'error');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            // Disable start button and change text
            startBtn.innerHTML = '<span class="spinner"></span>Capturing xpath';
            startBtn.disabled = true;

            fetch('/start_capture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    stopBtn.classList.add('show');
                } else {
                    showMessage(data.message, 'error');
                    startBtn.innerHTML = 'Start Capture';
                    startBtn.disabled = false;
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
                startBtn.innerHTML = 'Start Capture';
                startBtn.disabled = false;
            });
        }

        function stopCapture() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            fetch('/stop_capture', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    startBtn.innerHTML = 'Start Capture';
                    startBtn.disabled = false;
                    stopBtn.classList.remove('show');
                    
                    // Auto-refresh the selected JSON file after capture stops
                    const currentFile = document.getElementById('jsonFiles').value;
                    if (currentFile) {
                        setTimeout(() => {
                            loadJsonFile();
                        }, 1000); // Wait 1 second to ensure file is saved
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
            });
        }
        
        function refreshJsonFile() {
            const filename = document.getElementById('jsonFiles').value;
            if (filename) {
                loadJsonFile();
                showMessage('Refreshed!', 'success');
            }
        }
        
        function downloadCSV() {
            const filename = document.getElementById('jsonFiles').value;
            if (!filename) {
                showMessage('Please select a JSON file first', 'error');
                return;
            }
            
            // Create download link and trigger download
            window.location.href = '/download_csv/' + filename;
        }
        
        function openRecheckPage() {
            const filename = document.getElementById('jsonFiles').value;
            if (!filename) {
                showMessage('Please select a JSON file first', 'error');
                return;
            }
            
            // Navigate to recheck page with filename parameter
            window.location.href = '/recheck?file=' + encodeURIComponent(filename);
        }
        
        function deleteXPath(filename, pageUrl, index) {
            if (!confirm('Are you sure you want to delete this XPath?')) {
                return;
            }
            
            fetch('/delete_xpath', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    page_url: pageUrl,
                    xpath_index: index
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    // Reload the JSON file to reflect the deletion
                    loadJsonFile();
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
            });
        }

        function loadJsonFiles() {
            fetch('/list_json_files')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('jsonFiles');
                select.innerHTML = '<option value="">-- Select a file --</option>';
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = file;
                    select.appendChild(option);
                });
            });
        }

        function loadJsonFile() {
            const filename = document.getElementById('jsonFiles').value;
            const contentDiv = document.getElementById('jsonContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const recheckBtn = document.getElementById('recheckBtn');
            
            if (!filename) {
                contentDiv.innerHTML = '<div class="no-data">Select a JSON file to view captured xpaths</div>';
                refreshBtn.disabled = true;
                downloadBtn.disabled = true;
                recheckBtn.disabled = true;
                return;
            }
            
            // Enable refresh, download, and recheck buttons when a file is selected
            refreshBtn.disabled = false;
            downloadBtn.disabled = false;
            recheckBtn.disabled = false;

            fetch('/load_json/' + filename)
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    displayJsonContent(result.data, filename);
                } else {
                    contentDiv.innerHTML = '<div class="no-data">Error loading file: ' + result.message + '</div>';
                }
            });
        }

        function displayJsonContent(data, filename) {
            const contentDiv = document.getElementById('jsonContent');
            let html = '';
            
            // Sort pages by display_order in ascending order
            const sortedPages = Object.entries(data).sort((a, b) => {
                const orderA = a[1].display_order || 0;
                const orderB = b[1].display_order || 0;
                return orderA - orderB;
            });
            
            for (const [pageUrl, pageData] of sortedPages) {
                const pageName = pageData.page_name || 'Unnamed Page';
                const displayName = `${pageName} - ${pageUrl}`;
                
                html += `
                    <div class="page-section">
                        <div class="page-header" onclick="togglePage(this)">
                            <span>${displayName}</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="page-body">
                `;
                
                if (pageData.xpaths && pageData.xpaths.length > 0) {
                    // Sort xpaths by created_on in ascending order
                    const sortedXpaths = [...pageData.xpaths].sort((a, b) => {
                        const dateA = new Date(a.created_on || '1970-01-01');
                        const dateB = new Date(b.created_on || '1970-01-01');
                        return dateA - dateB;
                    });
                    
                    sortedXpaths.forEach((xpath, index) => {
                        html += `
                            <div class="xpath-item">
                                <label>Name:</label>
                                <input type="text" id="name_${pageUrl}_${index}" value="${escapeHtml(xpath.name || '')}">
                                
                                <label>Final XPath:</label>
                                <input type="text" id="final_${pageUrl}_${index}" value="${escapeHtml(xpath.final_xpath || '')}">
                                
                                <div class="xpath-details">
                                    <button class="toggle-details" onclick="toggleDetails(this)">Show All XPaths ‚ñº</button>
                                    <div class="details-content">
                                        <label>Relative XPath:</label>
                                        <div class="xpath-readonly xpath-with-count">
                                            <span class="xpath-value">${escapeHtml((xpath.relative_xpath && xpath.relative_xpath.xpath) ? xpath.relative_xpath.xpath : (typeof xpath.relative_xpath === 'string' ? xpath.relative_xpath : 'N/A'))}</span>
                                            ${(xpath.relative_xpath && typeof xpath.relative_xpath.count !== 'undefined') ? `<span class="xpath-count ${xpath.relative_xpath.count === 1 ? 'unique' : (xpath.relative_xpath.count === 0 ? 'invalid' : 'multiple')}">Count: ${xpath.relative_xpath.count}</span>` : ''}
                                        </div>
                                        
                                        <label>Full XPath:</label>
                                        <div class="xpath-readonly xpath-with-count">
                                            <span class="xpath-value">${escapeHtml((xpath.full_xpath && xpath.full_xpath.xpath) ? xpath.full_xpath.xpath : (typeof xpath.full_xpath === 'string' ? xpath.full_xpath : 'N/A'))}</span>
                                            ${(xpath.full_xpath && typeof xpath.full_xpath.count !== 'undefined') ? `<span class="xpath-count ${xpath.full_xpath.count === 1 ? 'unique' : (xpath.full_xpath.count === 0 ? 'invalid' : 'multiple')}">Count: ${xpath.full_xpath.count}</span>` : ''}
                                        </div>
                                        
                                        <label>CSS Selector:</label>
                                        <div class="xpath-readonly xpath-with-count">
                                            <span class="xpath-value">${escapeHtml((xpath.css_selector && xpath.css_selector.xpath) ? xpath.css_selector.xpath : (typeof xpath.css_selector === 'string' ? xpath.css_selector : 'N/A'))}</span>
                                            ${(xpath.css_selector && typeof xpath.css_selector.count !== 'undefined') ? `<span class="xpath-count ${xpath.css_selector.count === 1 ? 'unique' : (xpath.css_selector.count === 0 ? 'invalid' : 'multiple')}">Count: ${xpath.css_selector.count}</span>` : ''}
                                        </div>
                        `;
                        
                        // Add visual xpaths if they exist
                        if (xpath.visual_xpath) {
                            const visualLabels = {
                                text: 'Text',
                                tag_text: 'Tag + Text',
                                tag_contains: 'Tag Contains',
                                placeholder: 'Placeholder',
                                value: 'Value',
                                accessibility: 'Aria-Label',
                                name: 'Name',
                                href: 'Href',
                                src: 'Src',
                                alt: 'Alt',
                                title: 'Title'
                            };
                            
                            Object.entries(visualLabels).forEach(([key, label]) => {
                                const visualItem = xpath.visual_xpath[key];
                                if (visualItem) {
                                    const xpathValue = (typeof visualItem === 'object' && visualItem.xpath) ? visualItem.xpath : (typeof visualItem === 'string' ? visualItem : '');
                                    const count = (typeof visualItem === 'object' && typeof visualItem.count !== 'undefined') ? visualItem.count : null;
                                    
                                    if (xpathValue) {
                                        html += `
                                            <label>Visual XPath (${label}):</label>
                                            <div class="xpath-readonly xpath-with-count">
                                                <span class="xpath-value">${escapeHtml(xpathValue)}</span>
                                                ${count !== null ? `<span class="xpath-count ${count === 1 ? 'unique' : (count === 0 ? 'invalid' : 'multiple')}">Count: ${count}</span>` : ''}
                                            </div>
                                        `;
                                    }
                                }
                            });
                        }
                        
                        if (xpath.custom_xpath) {
                            html += `
                                <label>Custom XPath:</label>
                                <div class="xpath-readonly">${escapeHtml(xpath.custom_xpath)}</div>
                            `;
                        }
                        
                        html += `
                                    </div>
                                </div>
                                
                                <div class="button-container">
                                    <div style="width: 50%; text-align: left;">
                                        <button class="btn-save" onclick="saveXPath('${filename}', '${pageUrl}', ${index})">Save</button>
                                    </div>
                                    <div style="width: 50%; text-align: right;">
                                        <button class="btn-delete" onclick="deleteXPath('${filename}', '${pageUrl}', ${index})" title="Delete this xpath">üóëÔ∏è</button>
                                    </div>
                                    
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="no-data">No xpaths captured yet</div>';
                }
                
                html += '</div></div>';
            }
            
            if (html === '') {
                html = '<div class="no-data">No data available</div>';
            }
            
            contentDiv.innerHTML = html;
        }

        function togglePage(header) {
            const body = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            body.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        function toggleDetails(button) {
            const content = button.nextElementSibling;
            content.classList.toggle('show');
            if (content.classList.contains('show')) {
                button.textContent = 'Hide All XPaths ‚ñ≤';
            } else {
                button.textContent = 'Show All XPaths ‚ñº';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/"/g, '&quot;');
        }

        function saveXPath(filename, pageUrl, index) {
            const name = document.getElementById(`name_${pageUrl}_${index}`).value;
            const finalXpath = document.getElementById(`final_${pageUrl}_${index}`).value;
            
            fetch('/update_xpath', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    page_url: pageUrl,
                    xpath_index: index,
                    name: name,
                    final_xpath: finalXpath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
            });
        }

        // Check status on page load
        window.onload = function() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                if (data.running) {
                    const startBtn = document.getElementById('startBtn');
                    const stopBtn = document.getElementById('stopBtn');
                    startBtn.innerHTML = '<span class="spinner"></span>Capturing xpath';
                    startBtn.disabled = true;
                    stopBtn.classList.add('show');
                }
            });
            
            // Load JSON files list
            loadJsonFiles();
            
            // Refresh file list every 5 seconds if capturing
            setInterval(() => {
                fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.running) {
                        loadJsonFiles();
                        // Reload current file if selected
                        const currentFile = document.getElementById('jsonFiles').value;
                        if (currentFile) {
                            loadJsonFile();
                        }
                    }
                });
            }, 5000);
        };
    </script>
</body>
</html>